parameters:
  - name: stage
  - name: region

stages:
  - stage: ${{ parameters.stage }}_tf_plan_${{ parameters.region }}
    dependsOn: []
    variables:
      - template: ../variables/${{ parameters.stage }}/common.yml
      - group: ${{ parameters.stage }}
    jobs:
      - template: ../jobs/tf-plan.yml
        parameters:
          terraform_version: $(TF_VERSION)
          service_principal_id: $(SERVICE_PRINCIPAL_ID)
          service_principal_secret: $(SERVICE_PRINCIPAL_SECRET)
          tenant_id: $(TENANT_ID)
          subscription_id: $(SUBSCRIPTION_ID)
          storage_account_name: $(TF_STORAGE_ACCOUNT_NAME)
          working_directory: terraform
          terraform_backend_config: -backend-config="../terraform/environments/$(ENVIRONMENT)/tf-backend-${{ parameters.region }}.conf"
          terraform_parameters: -var-file="../terraform/environments/$(ENVIRONMENT)/terraform-${{ parameters.region }}.tfvars"
