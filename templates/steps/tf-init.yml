parameters:
  - name: storage_account_name
  - name: working_directory
  - name: terraform_version
  - name: terraform_backend_config

steps:
  # Terraform Init
  - bash: |
      # Download Terraform binary for Linux x64
      wget https://releases.hashicorp.com/terraform/${{ parameters.terraform_version }}/terraform_${{ parameters.terraform_version }}_linux_amd64.zip 2>&1
      unzip terraform_${{ parameters.terraform_version }}_linux_amd64.zip
      chmod +x terraform
      sudo mv -f terraform /usr/local/bin/

      # Terraform Init
      ACCESS_KEY=$(az storage account keys list \
        --account-name ${{ parameters.storage_account_name }} \
        --query "[0].value" | tr -d '"')

      terraform init -backend-config="access_key=${ACCESS_KEY}" ${{ parameters.terraform_backend_config }} -no-color
    displayName: "Terraform Init"
    failOnStderr: true
    workingDirectory: ${{ parameters.working_directory }}
